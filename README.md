# TRMNL Transport Plugin (Marketplace Edition)

This plugin displays the next 3 bus times (First Bus) and 3 train times (Greater Anglia) on your TRMNL device.

## Features
- **Bus Times**: Fetches live departures for a specific bus stop, filtering for "First Bus" services.
- **Train Times**: Fetches live departures for a specific train station, filtering for "Greater Anglia".
- **Smart Filtering**: Option to only show trains departing after a certain time (e.g., 30 mins) to account for walking time.
- **OAuth 2.0**: Securely connect your TRMNL account.
- **Webhooks**: Real-time installation and uninstallation notifications.
- **Configuration UI**: Easily manage your plugin settings.

### A Note on Security
For production environments, the `SECRET_KEY` must be a cryptographically secure random string. The example in the setup instructions is for development only.

## Setup

### 1. Prerequisites
- A [TransportAPI](https://developer.transportapi.com/) account (Free plan available).
- Get your `App ID` and `App Key`.
- A TRMNL account.

### 2. Backend Server
This plugin requires a backend server to handle OAuth, webhooks, and data fetching. You can host this Python Flask app on any provider (e.g., Render, Fly.io, Heroku, or your own server).

1.  **Clone the repository:**
    ```bash
    git clone https://github.com/your-username/trmnl-transport-plugin.git
    cd trmnl-transport-plugin
    ```
2.  **Install dependencies:**
    ```bash
    pip install -r requirements.txt
    ```
3.  **Set Environment Variables:**
    ```bash
    export FLASK_APP=project
    export SECRET_KEY='a-very-secret-key'
    export TRMNL_CLIENT_ID='your-trmnl-client-id'
    export TRMNL_CLIENT_SECRET='your-trmnl-client-secret'
    ```
4.  **Initialize the Database:**
    ```bash
    flask db upgrade
    ```
5.  **Run the Server:**
    ```bash
    gunicorn "project:create_app()"
    ```

### 3. TRMNL Configuration
1.  Go to the [TRMNL Plugin Marketplace](https://usetrmnl.com/plugins/my/new).
2.  Create a new plugin and fill in the following fields:
    - **Name:** TRMNL Transport Plugin
    - **Description:** Displays the next 3 bus and train times.
    - **Installation URL:** `https://your-app-url.com/install`
    - **Installation Success Webhook URL:** `https://your-app-url.com/webhook/installation_success`
    - **Plugin Management URL:** `https://your-app-url.com/manage`
    - **Plugin Markup URL:** `https://your-app-url.com/api/data`
    - **Uninstallation Webhook URL:** `https://your-app-url.com/webhook/uninstall`
3.  Once the plugin is created, you will get a **Client ID** and **Client Secret**. Add these to your environment variables.
4.  Install the plugin from the marketplace. You will be redirected to the configuration page to enter your TransportAPI credentials and station/stop codes.

### Important: API Limits
The **TransportAPI Free Plan** typically allows only **30 requests per day**.
- Set your TRMNL polling interval accordingly (e.g., every 60 minutes or Manual Refresh only).
- If you poll every 15 minutes, you will hit the limit in ~7 hours.
- Consider upgrading your TransportAPI plan if you need more frequent updates.

## Development

### Project Structure
- `config.py`: Application configuration settings.
- `project/`: Main application directory.
    - `__init__.py`: App factory and extension initialization.
    - `main.py`: Main routes (installation, webhooks, settings, API) and logic.
    - `models.py`: Database models (User, Installation).
    - `oauth.py`: OAuth 2.0 configuration.
    - `decorators.py`: Authentication decorators.
    - `tests/`: Additional tests.
- `test_app.py`: Main integration tests.
- `migrations/`: Database migration scripts (generated by Flask-Migrate).

### Running Tests
To run the tests, use the following command:

```bash
python test_app.py
```
Or for the bug-specific tests:
```bash
python -m unittest project/tests/test_bug.py
```

### Code Style & Documentation
This project uses **Google Style Python Docstrings**. Please ensure all new functions, methods, and classes are fully documented.
